---
- hosts: all
  become: yes
  tasks:
    - name: Install dependencies
      yum:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
          - iproute-tc
        state: present

    - name: Disable SELinux
      shell: |
        setenforce 0
        sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
      args:
        executable: /bin/bash

    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/swap/d' /etc/fstab
      args:
        executable: /bin/bash

    - name: Set sysctl parameters for Kubernetes networking
      shell: |
        cat <<EOF | tee /etc/sysctl.d/k8s.conf
        net.bridge.bridge-nf-call-ip6tables = 1
        net.bridge.bridge-nf-call-iptables = 1
        EOF
        sysctl --system
      args:
        executable: /bin/bash

    - name: Install containerd
      shell: |
        yum install -y containerd
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
      args:
        executable: /bin/bash

    - name: Enable and start containerd
      service:
        name: containerd
        enabled: yes
        state: started

    - name: Add Kubernetes repository
      shell: |
        cat <<EOF > /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
        enabled=1
        gpgcheck=1
        repo_gpgcheck=1
        gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
        EOF
      args:
        executable: /bin/bash

    - name: Install kubeadm, kubelet, and kubectl
      yum:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        disable_excludes: kubernetes

    - name: Enable kubelet
      service:
        name: kubelet
        enabled: yes

- hosts: master
  become: yes
  tasks:
    - name: Initialize Kubernetes cluster
      shell: |
        kubeadm init --cri-socket unix:///run/containerd/containerd.sock --pod-network-cidr=192.168.0.0/16 --apiserver-advertise-address=$(hostname -I | awk '{print $1}')
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Create .kube directory
      file:
        path: /home/ec2-user/.kube
        state: directory
        owner: ec2-user
        group: ec2-user
        mode: '0755'

    - name: Copy Kubernetes admin config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ec2-user/.kube/config
        remote_src: yes
        owner: ec2-user
        group: ec2-user
        mode: '0600'

    - name: Install Calico network plugin
      shell: |
        kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
      become_user: ec2-user

    - name: Generate join command
      shell: |
        kubeadm token create --print-join-command
      register: join_command
      changed_when: false

    - name: Save join command
      copy:
        content: "{{ join_command.stdout }}"
        dest: /tmp/k8s_join.sh
        mode: '0755'

- hosts: workers
  become: yes
  tasks:
    - name: Copy join command from master
      fetch:
        src: /tmp/k8s_join.sh
        dest: /tmp/k8s_join.sh
        flat: yes

    - name: Run join command on workers
      shell: sh /tmp/k8s_join.sh
      args:
        executable: /bin/bash
